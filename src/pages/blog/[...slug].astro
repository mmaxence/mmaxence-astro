---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import PageContent from '../../components/ui/PageContent.astro';
import AnimatedContent from '../../components/ui/AnimatedContent.astro';
import ThemeToast from '../../components/ui/ThemeToast.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts
    .filter((post) => !post.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

// Extract YouTube video ID from various URL formats
function getYouTubeId(url: string): string | null {
  if (!url) return null;
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
  ];
  const match = url.match(patterns[0]);
  return match ? match[1] : null;
}

const videoId = post.data.related_video ? getYouTubeId(post.data.related_video) : null;
---

<BaseLayout 
  title={post.data.title} 
  description={post.data.description || post.data.title}
  featured_image={post.data.featured_image}
  url={new URL(`/blog/${post.slug}`, Astro.site).href}
  type="article"
>
  <Header />
  <PageContent class="flex flex-col items-center pb-4 min-h-screen">
    <article class="max-w-3xl mx-auto px-3 md:px-6 py-12">
      {post.data.featured_image && (() => {
        const featuredImage = post.data.featured_image.startsWith('/') 
          ? post.data.featured_image 
          : `/blog/${post.slug}/${post.data.featured_image}`;
        return (
          <div class="mb-8">
            <img 
              src={featuredImage} 
              alt={post.data.title}
              class="w-full h-auto rounded-lg"
            />
          {post.data.credential && (
            <p class="text-sm text-gray-500 mt-2">
              {post.data.credentiallink ? (
                <a 
                  href={post.data.credentiallink} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="credential"
                  style="color: var(--theme-text-muted);"
                >
                  {post.data.credential}
                </a>
              ) : (
                <span class="credential">{post.data.credential}</span>
              )}
            </p>
          )}
          </div>
        );
      })()}
      
      <header class="mb-8">
        <h1 class="text-4xl md:text-5xl font-mono font-light mb-4">
          {post.data.title}
        </h1>
            <time class="text-sm" style="color: var(--theme-text-muted);">
          {post.data.date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}
        </time>
      </header>
      
          <div class="prose prose-lg max-w-none leading-relaxed" style="color: var(--theme-text); opacity: 0.9;">
        <Content />
      </div>

      {videoId && (
        <section class="mt-12 pt-8 border-t" style="border-color: var(--theme-text-muted);">
          <h2 class="text-xl font-mono font-light mb-2" style="color: var(--theme-text);">Related</h2>
          {post.data.related_video_context && (
            <p class="text-sm mb-4" style="color: var(--theme-text-muted);">
              {post.data.related_video_context}
            </p>
          )}
          <div class="aspect-video w-full max-w-2xl rounded-lg overflow-hidden">
            <iframe
              src={`https://www.youtube.com/embed/${videoId}`}
              title="Related video"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              class="w-full h-full"
            />
          </div>
          <a
            href={post.data.related_video!}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-block mt-2 text-sm hover:underline"
            style="color: var(--theme-text-muted);"
          >
            Watch on YouTube â†’
          </a>
        </section>
      )}
        </article>
  </PageContent>
  <Footer />
  <ThemeToast />
</BaseLayout>

